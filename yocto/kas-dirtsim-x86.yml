# KAS configuration for DirtSim x86_64 runtime image.
#
# Usage:
#   kas build kas-dirtsim-x86.yml

header:
  version: 14

distro: poky
machine: genericx86-64

repos:
  poky:
    url: "https://git.yoctoproject.org/poky"
    branch: scarthgap
    layers:
      meta:
      meta-poky:
      meta-yocto-bsp:

  meta-openembedded:
    url: "https://git.openembedded.org/meta-openembedded"
    branch: scarthgap
    layers:
      meta-multimedia:
      meta-networking:
      meta-oe:
      meta-python:

  meta-raspberrypi:
    url: "https://git.yoctoproject.org/meta-raspberrypi"
    branch: scarthgap

  meta-pi-base:
    path: pi-base/yocto/meta-pi-base

  meta-dirtsim:
    path: meta-dirtsim

local_conf_header:
  base: |
    #
    # WARNING: This file is AUTO-GENERATED by KAS from kas-dirtsim-x86.yml
    # DO NOT EDIT THIS FILE DIRECTLY - your changes will be overwritten!
    # Edit kas-dirtsim-x86.yml instead and run 'kas build kas-dirtsim-x86.yml'
    #

    INIT_MANAGER = "systemd"
    PACKAGECONFIG:append:pn-systemd = " coredump"

    # Accept restricted licenses (needed for openh264).
    LICENSE_FLAGS_ACCEPTED = "commercial synaptics-killswitch"

    # Enable X11 packages for Xvfb runtime.
    DISTRO_FEATURES:append = " x11"

    # Ensure Xvfb package is built for the rootfs.
    PACKAGECONFIG:append:pn-xserver-xorg = " xvfb"

    IMAGE_FSTYPES = "tar.gz"

    # Use conservative parallelism for containers; override with env vars.
    BB_NUMBER_THREADS = "${@os.getenv('DIRTSIM_BB_NUMBER_THREADS', '4')}"
    PARALLEL_MAKE = "-j ${@os.getenv('DIRTSIM_PARALLEL_MAKE', '4')}"

    # Cache root (override with DIRTSIM_CACHE_ROOT in the environment).
    BB_ENV_PASSTHROUGH_ADDITIONS:append = " DIRTSIM_CACHE_ROOT"
    DIRTSIM_CACHE_ROOT = "${@os.getenv('DIRTSIM_CACHE_ROOT', '/home/data/linux1/yocto-cache' if os.path.isdir('/home/data/linux1') else '/home/data/workspace/yocto-cache')}"

    # Download directory (shared across builds).
    DL_DIR ?= "${DIRTSIM_CACHE_ROOT}/downloads"

    # Shared state cache (speeds up rebuilds).
    SSTATE_DIR ?= "${DIRTSIM_CACHE_ROOT}/sstate-cache"

    # Ccache for faster rebuilds (local cache).
    INHERIT += "ccache"
    CCACHE_DIR ?= "${DIRTSIM_CACHE_ROOT}/.ccache/dirtsim-yocto"
    CCACHE_MAXSIZE ?= "20G"
    PSEUDO_IGNORE_PATHS:append = ":${CCACHE_DIR}"

    # Prune work dirs after packaging to keep disk usage down.
    INHERIT += "rm_work"

    # Disable SPDX generation (requires user namespaces which may not be available).
    INHERIT:remove = "create-spdx"

target: dirtsim-x86-image
