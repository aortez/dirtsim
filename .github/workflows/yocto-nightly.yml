name: Yocto Nightly

on:
  schedule:
    - cron: "0 11 * * *"
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  yocto-build:
    runs-on: self-hosted
    env:
      DL_DIR: /home/data/linux1/yocto-cache/downloads
      SSTATE_DIR: /home/data/linux1/yocto-cache/sstate-cache
      CCACHE_DIR: /home/data/linux1/yocto-cache/.ccache/dirtsim-yocto
      DIRTSIM_CACHE_ROOT: /home/data/linux1/yocto-cache
      KAS_REPOS_DIR: /home/data/linux1/yocto-cache/kas-repos

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        clean: false
        submodules: recursive
        fetch-depth: 0

    - name: Prepare Yocto cache
      run: |
        CACHE_ROOT="${DIRTSIM_CACHE_ROOT}"
        mkdir -p \
          "${CACHE_ROOT}/downloads" \
          "${CACHE_ROOT}/sstate-cache" \
          "${CACHE_ROOT}/.ccache/dirtsim-yocto" \
          "${CACHE_ROOT}/kas-repos" \
          "${CACHE_ROOT}/kas-build-x86" \
          "${CACHE_ROOT}/kas-build-pi"
        find "${CACHE_ROOT}/sstate-cache" -type f -mtime +7 -delete || true
        find "${CACHE_ROOT}/downloads" -type f -mtime +7 -delete || true
        find "${CACHE_ROOT}/.ccache/dirtsim-yocto" -type f -mtime +7 -delete || true

    - name: Install Yocto npm deps
      working-directory: yocto
      run: npm install --no-package-lock

    - name: Yocto build (docker)
      working-directory: yocto
      env:
        KAS_BUILD_DIR: /home/data/linux1/yocto-cache/kas-build-pi
      run: npm run docker-build

    - name: Build + publish x86 runtime container image
      working-directory: yocto
      env:
        KAS_BUILD_DIR: /home/data/linux1/yocto-cache/kas-build-x86
        DIRTSIM_RUNTIME_REGISTRY: oldman-desktop.local:5000
      run: npm run runtime-image -- --build --publish

  docker-cleanup:
    uses: ./.github/workflows/docker-cleanup.yml
    needs: yocto-build
    if: always()
