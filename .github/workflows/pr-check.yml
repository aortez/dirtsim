name: PR Check

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, labeled, unlabeled ]
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-docker-image:
    uses: ./.github/workflows/docker-build.yml

  build-and-test:
    runs-on: self-hosted
    needs: build-docker-image
    if: contains(github.event.pull_request.labels.*.name, 'iheartci') || github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        clean: true
        submodules: recursive
        fetch-depth: 0

    - name: Merge target branch
      if: github.event_name == 'pull_request'
      run: .github/scripts/merge-target-branch.sh ${{ github.event.pull_request.base.ref }}

    - name: Check code formatting
      working-directory: docker
      run: make format-check

    - name: Build debug version
      working-directory: docker
      run: |
        START=$(date +%s)
        make build-debug
        echo "BUILD_TIME=$(($(date +%s) - START))" >> $GITHUB_ENV

    - name: Build stats
      working-directory: docker
      run: |
        echo "### Build Stats" >> $GITHUB_STEP_SUMMARY
        echo "- **Build time:** ${{ env.BUILD_TIME }}s" >> $GITHUB_STEP_SUMMARY
        echo "- **ccache stats:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        make ccache-stats >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Run unit tests
      working-directory: docker
      run: make test
