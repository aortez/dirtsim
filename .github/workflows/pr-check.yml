name: PR Check

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, labeled, unlabeled ]
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-docker-image:
    uses: ./.github/workflows/docker-build.yml
    if: contains(github.event.pull_request.labels.*.name, 'iheartci') || github.event_name == 'push' || github.event_name == 'workflow_dispatch'

  build-and-test:
    runs-on: self-hosted
    needs: build-docker-image
    if: contains(github.event.pull_request.labels.*.name, 'iheartci') || github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        clean: true
        submodules: recursive
        fetch-depth: 0

    - name: Merge target branch
      if: github.event_name == 'pull_request'
      run: .github/scripts/merge-target-branch.sh ${{ github.event.pull_request.base.ref }}

    - name: Lint JavaScript
      working-directory: docker
      run: make lint

    - name: Check code formatting
      working-directory: docker
      run: make format-check

    - name: Build debug version
      working-directory: docker
      run: |
        START=$(date +%s)
        make build-debug
        echo "BUILD_TIME=$(($(date +%s) - START))" >> $GITHUB_ENV

    - name: Build stats
      working-directory: docker
      run: |
        echo "### Build Stats" >> $GITHUB_STEP_SUMMARY
        echo "- **Build time:** ${{ env.BUILD_TIME }}s" >> $GITHUB_STEP_SUMMARY
        echo "- **ccache stats:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        make ccache-stats >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Run unit tests
      working-directory: docker
      run: make test

    - name: Prepare Yocto cache
      run: |
        CACHE_ROOT="/home/data/linux1/yocto-cache"
        mkdir -p "${CACHE_ROOT}/downloads" "${CACHE_ROOT}/sstate-cache" "${CACHE_ROOT}/.ccache/dirtsim-yocto"
        find "${CACHE_ROOT}/sstate-cache" -type f -mtime +7 -delete || true
        find "${CACHE_ROOT}/downloads" -type f -mtime +7 -delete || true
        find "${CACHE_ROOT}/.ccache/dirtsim-yocto" -type f -mtime +7 -delete || true

    - name: Build Yocto runtime image
      working-directory: yocto
      env:
        DL_DIR: /home/data/linux1/yocto-cache/downloads
        SSTATE_DIR: /home/data/linux1/yocto-cache/sstate-cache
        CCACHE_DIR: /home/data/linux1/yocto-cache/.ccache/dirtsim-yocto
        DIRTSIM_CACHE_ROOT: /home/data/linux1/yocto-cache
        DIRTSIM_RUNTIME_REGISTRY: oldman-desktop.local:5000
      run: npm run runtime-image -- --build

    - name: Run integration test in Yocto runtime
      run: |
        DATA_DIR="${RUNNER_TEMP}/dirtsim-data"
        mkdir -p "${DATA_DIR}"
        docker run --rm \
          -v "${GITHUB_WORKSPACE}:/workspace" \
          -v "${DATA_DIR}:/data" \
          -w /workspace \
          -e DIRTSIM_OS_MANAGER_BIN=/usr/bin/dirtsim-os-manager \
          -e DIRTSIM_CLI_BIN=/usr/bin/dirtsim-cli \
          "dirtsim-runtime:x86-nightly" \
          /bin/sh /workspace/apps/scripts/os-manager-integration-test.sh

    - name: Run functional tests in Yocto runtime
      run: |
        DATA_DIR="${RUNNER_TEMP}/dirtsim-data-functional"
        mkdir -p "${DATA_DIR}"
        docker run --rm \
          -v "${GITHUB_WORKSPACE}:/workspace" \
          -v "${DATA_DIR}:/data" \
          -w /workspace \
          -e DIRTSIM_OS_MANAGER_BIN=/workspace/apps/build-debug/bin/dirtsim-os-manager \
          -e DIRTSIM_CLI_BIN=/workspace/apps/build-debug/bin/cli \
          -e DIRTSIM_FUNCTIONAL_TIMEOUT_MS=15000 \
          "dirtsim-runtime:x86-nightly" \
          /bin/sh /workspace/apps/scripts/os-manager-functional-tests.sh 2>&1 | tee functional-tests.log
        TEST_EXIT=${PIPESTATUS[0]}
        # Extract markdown table from output and add to step summary.
        sed -n '/^### Functional Tests/,/^os-manager functional tests/p' functional-tests.log | head -n -1 >> $GITHUB_STEP_SUMMARY
        exit $TEST_EXIT
